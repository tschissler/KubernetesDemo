@page "/"
@using System.Net.Http
@using PrimeDecompositionUi.Data
@using System.Net.Http.Json
@using Dtos
@using MatBlazor
@using Plotly.Blazor
@using Plotly.Blazor.LayoutLib
@using Plotly.Blazor.Traces

@inject HttpClient httpClient

<h1>Enter Parameter for Prime Decomposition</h1>
<EditForm Model="@_numberGeneratorParameter">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <div class="m-4">
        <label>Max number:</label>
        <br />
        <MatSlider 
                    Discrete="true" 
                    Step="1000" 
                    EnableStep="true" 
                    Immediate="true" 
                    @bind-Value="@maxVal" 
                    TValue="long" 
                    ValueMin="0" 
                    ValueMax="50000000"
                    Disabled="@_running"/>
        <MatNumericUpDownField 
                               @bind-Value=@_numberGeneratorParameter.MaxNumber
                               Step="1000"
                               Format="#,##0"
                               DecimalPlaces=0
                               Disabled="@_running"/>
        
    </div>
    <div class="m-4">
        <label for="intervalinmillis">Interval in Milliseconds:</label>
        <br />
                <MatSlider 
                    Discrete="true" 
                    Step="10" 
                    EnableStep="true" 
                    Immediate="true" 
                    @bind-Value="@intervalVal" 
                    TValue="long" 
                    ValueMin="0" 
                    ValueMax="1000"
                    Disabled="@_running"/>
        <MatNumericUpDownField 
                               @bind-Value=@_numberGeneratorParameter.IntervalInMillis
                               Step="10"
                               Format="#,##0"
                               DecimalPlaces=0
                               Disabled="@_running"/>
    </div>
</EditForm>
<div class="m-4">
    <button class="btn-lg" type="button" @onclick="Start" disabled="@_running">Start</button>
    <button class="btn-lg" type="button" @onclick="Stop" disabled="@(!_running)">Stop</button>
    <button class="btn-lg" type="button" @onclick="ResetStats" disabled="@(!Statistics.Any())">Reset stats</button>
</div>
<div class="container">
    <div class="row">
<div class="col-6">
    <ul>
        @foreach (var stat in Statistics)
        {
            <li>@stat.Number = @string.Join(" * ", stat.Result) (@stat.DurationInMilliseconds ms)</li>
        }
    </ul>
</div>
<div class="col-6">
            <PlotlyChart Id="TestId" Config="config" Layout="layout" Data="data" @ref="chart"/>
        </div>
    </div>
</div>

@code
{
    PlotlyChart chart;

    Config config = new Config
    {
        Responsive = true
    };

    Layout layout = new Layout
    {
        Title = new Title
        {
            Text = "Average Calculation Times"
        },
        BarMode = BarModeEnum.Overlay,
        Height = 500
    };

    List<ITrace> data = new List<ITrace>
    {
        new Bar
        {
            X = new List<object> {0},
            Y = new List<object> {0}
        }
    };

    int lastConsideredIndexForAverage = 0;
    int chart_x = 1;

    private long maxVal
    {
        get => _numberGeneratorParameter.MaxNumber;
        set
        {
            _numberGeneratorParameter.MaxNumber = value;
            this.StateHasChanged();
        }
    }

    private long intervalVal
    {
        get => _numberGeneratorParameter.IntervalInMillis;
        set
        {
            _numberGeneratorParameter.IntervalInMillis = value;
            this.StateHasChanged();
        }
    }

    private readonly NumberGeneratorParameter _numberGeneratorParameter = new();

    private List<CallStatisticDto> Statistics { get; set; } = new();

    private readonly string _url = Environment.GetEnvironmentVariable("NUMBER_GENERATOR_URL");

    private bool _running = false;

    private System.Timers.Timer _timer;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
    }

@*    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        UpdateStats().Wait();
        return base.OnAfterRenderAsync(firstRender);
    }*@

    private void OnSliderChanged(long value)
    {
        maxVal = value;
    }

    private async Task Start()
    {
        if (_running)
        {
            return;
        }

        await httpClient.GetAsync($"{_url}/start?max={_numberGeneratorParameter.MaxNumber}&interval={_numberGeneratorParameter.IntervalInMillis}");
        _running = true;
        _timer = new System.Timers.Timer(500);
        _timer.Elapsed += async (_, _) => await UpdateStats();
        _timer.Start();
    }

    private Task Stop()
    {
        _running = false;
        _timer.Stop();
        return httpClient.GetAsync($"{_url}/stop");
    }

    private async Task UpdateStats()
    {
        var response = await httpClient.GetAsync($"{_url}/stats");
        Statistics = await response.Content.ReadFromJsonAsync<List<CallStatisticDto>>();
        await InvokeAsync(StateHasChanged);
        
        if (Statistics.Count >= lastConsideredIndexForAverage + 10)
        {
            if (!(chart.Data.FirstOrDefault() is Bar bar)) return;

            var y = Statistics.Skip(lastConsideredIndexForAverage).Average(i => i.DurationInMilliseconds);
            await chart.PrependTrace(chart_x, y, data.IndexOf(bar));

            lastConsideredIndexForAverage = Statistics.Count;
            chart_x++;
        }
    }

    private async Task ResetStats()
    {
        await httpClient.GetAsync($"{_url}/reset");
        await UpdateStats();
        lastConsideredIndexForAverage = 0;
        chart_x = 1;

        if (!(chart.Data.FirstOrDefault() is Bar bar)) return;
        bar.X.Clear();
        bar.Y.Clear();
        chart.React();
    }
}
